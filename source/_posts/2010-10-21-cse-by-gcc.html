---
layout: post
title: Common Subexpression Elimination (CSE) by GCC
date: '2010-10-21T21:39:00.005+05:30'
author: Hari John Kuriakose
tags:
- C
- computing
modified_time: '2010-10-26T00:25:46.050+05:30'
blogger_id: tag:blogger.com,1999:blog-3368921059404601044.post-2528684752654991428
blogger_orig_url: http://harijohnkuriakose.blogspot.com/2010/10/cse-by-gcc.html
---

<div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b><u>Test Program</u></b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp;main()</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;{</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int i, j, k, r;</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;scanf("%d%d", &amp;i, &amp;j);</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<b>k = i + j + 10;</b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;r = i + j + 30;&nbsp;</b>&nbsp;</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;printf("%d %d %d\n", k, r);</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;}</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b><u>Assemly Code</u></b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">AT&amp;T format of assembly code is used.</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp;</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp;main:</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pushl &nbsp; %ebp</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%esp, %ebp</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;andl &nbsp; &nbsp;$-16, %esp</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;subl &nbsp; &nbsp;$32, %esp</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;leal &nbsp; &nbsp;24(%esp), %eax</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 8(%esp)</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;leal &nbsp; &nbsp;28(%esp), %eax</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 4(%esp)</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;$.LC0, (%esp)</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;call &nbsp; &nbsp;scanf</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;28(%esp), %edx</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;24(%esp), %eax</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<b>leal &nbsp; &nbsp;(%edx,%eax), %eax</b><br /><b><span class="Apple-style-span" style="font-weight: normal;"><b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;addl &nbsp; &nbsp;$10, %eax</b></span></b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 20(%esp)</b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;28(%esp), %edx</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;24(%esp), %eax</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<b>leal &nbsp; &nbsp;(%edx,%eax), %eax</b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;addl &nbsp; &nbsp;$30, %eax</b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 16(%esp)</b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;16(%esp), %eax</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 8(%esp)</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;20(%esp), %eax</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 4(%esp)</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;$.LC1, (%esp)</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;call &nbsp; &nbsp;printf</div><div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;leave</div></div><div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ret</div></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">The two blocks in bold represents the evaluation of 'k' and 'r' in the test program respectively.</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">The '<b><span class="Apple-style-span" style="font-weight: normal;"><b>leal &nbsp; &nbsp;(%edx,%eax), %eax'</b></span>&nbsp;</b>command adds the two values in the 'edx' and 'eax' and stores the result in 'eax'. The '<b>addl'&nbsp;</b>command adds a constant to the value in the 'eax'.</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">Here,&nbsp;<b>both 'leal' and 'addl' are called two times</b>, for the evaluation of 'k' and 'r' respectively.</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;After optimization as:</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">&nbsp;&nbsp; &nbsp;<b>gcc -S -O3 -fomit-frame-pointer opt2.c</b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b>&nbsp;&nbsp; &nbsp;less opt2.s</b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b><br /></b></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><b><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp;main:</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pushl &nbsp; %ebp</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%esp, %ebp</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;andl &nbsp; &nbsp;$-16, %esp</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;subl &nbsp; &nbsp;$32, %esp</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;leal &nbsp; &nbsp;24(%esp), %eax</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 8(%esp)</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;leal &nbsp; &nbsp;28(%esp), %eax</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 4(%esp)</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;$.LC0, (%esp)</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;call &nbsp; &nbsp;scanf</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span>movl &nbsp; &nbsp;24(%esp), %eax<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;addl &nbsp; &nbsp;28(%esp), %eax<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;$.LC1, (%esp)<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;leal &nbsp; &nbsp;30(%eax), %edx<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;addl &nbsp; &nbsp;$10, %eax<br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%edx, 8(%esp)</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;movl &nbsp; &nbsp;%eax, 4(%esp)</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;call &nbsp; &nbsp;printf</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;leave</span><br /><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ret</span><br /><span class="Apple-style-span" style="font-weight: normal;"><br /></span><span class="Apple-style-span" style="font-weight: normal;">Here, what is seen to be done is:</span><br /><span class="Apple-style-span" style="font-weight: normal;">1)</span></b><b><span class="Apple-style-span" style="font-weight: normal;">&nbsp;<b><b></b></b></span></b><br /><b><span class="Apple-style-span" style="font-weight: normal;"><b><b><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important;"><span class="Apple-style-span" style="font-weight: normal;">'i' in the test program stored in 'eax'</span></div></div></div></div></div></div></div></b></b></span></b><br /></div><b><b></b></b><br /><b><b></b></b><br /><b><b><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="display: inline !important;"><div style="display: inline !important;"><span class="Apple-style-span" style="font-weight: normal;">2) 'j' added to 'eax'</span></div></div></div></div></div></div></div></div></b></b><br /><b><b></b></b><br /><b><b></b></b><br /><b><b><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important;"><div style="display: inline !important; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="display: inline !important;"><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span>Now 'eax' contains 'i' + 'j'<span class="Apple-style-span" style="font-weight: normal;">.</span></div></div></div></div></div></b></b><br /><b><b></b></b><br /><b><b><div style="display: inline !important;"><div style="display: inline !important; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="display: inline !important;"><div style="display: inline !important;"><span class="Apple-style-span" style="font-weight: normal;">3) 'r' is obtained as " 30 + the value in 'eax' "</span></div></div></div></div></b></b><br /><br /><b><b></b></b><br /><b><b><div style="display: inline !important;"><div style="display: inline !important; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="display: inline !important;"><span class="Apple-style-span" style="font-weight: normal;">4) 'k' is obtained by adding 10 to the value in 'eax'</span></div></div></div></b></b><br /><b><span class="Apple-style-span" style="font-weight: normal;"><b><b><div style="display: inline !important;"><div style="display: inline !important;"><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><span class="Apple-style-span" style="font-weight: normal;">Observation is:</span></div></div></div></b></b></span><span class="Apple-style-span" style="font-weight: normal;"><b><b><div style="display: inline !important;"><div style="display: inline !important;"><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><span class="Apple-style-span" style="font-weight: normal;">&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;</span>&nbsp;'i' + 'j' was evaluated only once !</div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div></div></div></b></b></span><u>Common Subexpression Evaluation (CSE)</u><br /><span class="Apple-style-span" style="font-weight: normal;"></span><br /><span class="Apple-style-span" style="font-weight: normal;">As observed, CSE is an optimization technique employed by the compiler, when the same subexpression is present in more than one expressions.</span><br /><span class="Apple-style-span" style="font-weight: normal;"><br /></span><span class="Apple-style-span" style="font-weight: normal;">It is as if the subexpression is evaluated first, and the result is stored in a temporary variable. For all further calculations where this subexpression was a part originally, the value of this newly created temporary variable will be used.</span><br /><span class="Apple-style-span" style="font-weight: normal;"></span><span class="Apple-style-span" style="font-weight: normal;">In the test program used above, the so evaluated subexpression is '</span>&nbsp;i + j&nbsp;<span class="Apple-style-span" style="font-weight: normal;">'.</span><br /><span class="Apple-style-span" style="font-weight: normal;"><br /></span><span class="Apple-style-span" style="font-weight: normal;">Also,&nbsp;</span><span class="Apple-style-span">CSE is performed only when, in that environment,&nbsp;</span><span class="Apple-style-span">the cost to use such a temporary variable is lesser than the cost to perform the operations in the subexpression itself.</span><span class="Apple-style-span" style="font-weight: normal;">&nbsp;Here, the operation is '+'.&nbsp;</span></b>