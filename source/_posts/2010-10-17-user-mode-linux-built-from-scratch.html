---
layout: post
title: User Mode Linux Built From Scratch !!!
date: '2010-10-17T08:43:00.007+05:30'
author: Hari John Kuriakose
tags:
- GNU/Linux
- computing
modified_time: '2010-10-20T08:10:22.156+05:30'
thumbnail: http://4.bp.blogspot.com/_rkBB8V8TgZY/TLpdcbjMslI/AAAAAAAAATA/n2V1nO6Y8B4/s72-c/uml.png
blogger_id: tag:blogger.com,1999:blog-3368921059404601044.post-6222556591281234011
blogger_orig_url: http://harijohnkuriakose.blogspot.com/2010/10/user-mode-linux-built-from-scratch.html
---

<b><u>Linux From Scratch</u></b><br /><blockquote>"Linux From Scratch (LFS) is a project that provides you with step-by-step instructions for building your own custom Linux system, entirely from source code."</blockquote>Homepage is : <a href="http://www.linuxfromscratch.org/">http://www.linuxfromscratch.org/</a> .<br /><div><div><br /></div><b><u>Use Mode Linux</u></b><br /><blockquote>"User-Mode Linux is a safe, secure way of running Linux versions and Linux processes. Run buggy software, experiment with new Linux kernels or distributions, and poke around in the internals of Linux, all without risking your main Linux setup.</blockquote><blockquote>User-Mode Linux gives you a virtual machine that may have more hardware and software virtual resources than your actual, physical computer. Disk storage for the virtual machine is entirely contained inside a single file on your physical machine. You can assign your virtual machine only the hardware access you want it to have. With properly limited access, nothing you do on the virtual machine can change or damage your real computer, or its software."</blockquote><div>Homepage is :&nbsp;<a href="http://user-mode-linux.sourceforge.net/">http://user-mode-linux.sourceforge.net/</a>&nbsp;.</div><div><br /><b><u>UML - The kernel on top of a kernel&nbsp;</u></b><br /><br />To get the complete idea, it is true that the UML kernel can be booted and shutdown from your Linux system, just like another application. It will not cause your Linux system to halt in any way.<br /><br />How is the required <b>privilege levels</b> setup for the UML kernel?<br />The privilege levels in a Linux system ranges from 0 (<b>ring 0</b>) to 3 (<b>ring 3</b>). Ring 0 gives you complete power. You can change the contents of any register, do anything. Ring 3 is the user mode. It also has the lowest privilege.<br /><br />This is the same in the UML kernel too.<br /><br /><b>Can a C code get privilege level 0</b>?<br />Yes it can. Through system calls. But it cannot be allowed just like that. Allowing a C code full control will be like allowing viruses to grow in Linux! The C code must be able to make system calls, and simultaneously not be the one who is in possession of the control flow.<br /><br />This is the specific design technique employed in Linux. When a system call occurs in a C code, there will be a switching from ring 0 to ring 3. It will be simultaneously accompanied with transfer of control from the C program to the Linux kernel. No hassle there.<br /><br />Thus, total safety is ensured.<br /><br />How is <b>the UML kernel design</b>ed then?<br />A Linux kernel comprises of two parts:<br />1) the hardware dependent part - specifically, everything inside the '<b>arch</b>'<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;folder in the kernel source code.<br />2) others<br /><br />What is done in the UML kernel is that:<br />1) take away all the hardware dependent part of the kernel.<br />2) simply replace it with the system calls of the kernel layer below<br />&nbsp;&nbsp; &nbsp;it (pure C code).<br />&nbsp;&nbsp; &nbsp;(the UML kernel will behave just as an application)<br /><br />Consider a sample executable binary 'a.out' compiled inside the UML kernel, from a sample file 'a.c'.<br /><br /><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: left; margin-right: 1em; text-align: left;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLpdcbjMslI/AAAAAAAAATA/n2V1nO6Y8B4/s1600/uml.png" imageanchor="1" style="clear: left; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" src="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLpdcbjMslI/AAAAAAAAATA/n2V1nO6Y8B4/s1600/uml.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 1. The kernel layers</td></tr></tbody></table><br />a.out makes a system call<br />e.g. read( )<br /><br /><br />replace a.out's call with the address of<br />its own&nbsp;read( )<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />The <b>mechanism</b>:<br />The UML kernel uses <b>ptrace( )</b>&nbsp;to freeze 'a.out', the moment it invokes a system call. Then, the address of this function call is replaced with a corresponding system call address that is part of the UML kernel itself.<br /><br />Everything works fine, in a cute way.<br /><br /><b><u>Compiling and Booting the UML kernel</u></b><br /><br />While compiling the kernel, just add an extra parameter '<b>ARCH=um</b>' to <b>all the steps</b> outlined in the Linux kernel README.<br />After compilation, an executable binary called '<b>linux</b>' will be created.<br /><br />Assuming 'linux' is present in your current directory, to boot into the UML kernel give the command as:<br />&nbsp;&nbsp; &nbsp;<b>./linux ubda=&lt;&nbsp;path of the filesystem &gt;</b><path be="" filesystem="" of="" the="" to="" used=""></path><br /><br />where filesystem can be a physical partition, or one created with the <b>dd</b> and <b>mkfs</b>/<b>mke2fs</b> commands.<br /><br /><b><u>Some Snapshots</u></b><br /><b><u><br /></u></b></div><div><b>'Make'ing Glibc&nbsp;</b></div><div><div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLna4GEUZrI/AAAAAAAAASc/UBfLNYeaAas/s1600/Screenshot-3.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="179" src="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLna4GEUZrI/AAAAAAAAASc/UBfLNYeaAas/s320/Screenshot-3.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 2. Running 'make' for glibc</td></tr></tbody></table><b>&nbsp;'Configure'ing&nbsp;Bash</b><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLnbAX7lGeI/AAAAAAAAASg/2E1eF3fsigw/s1600/Screenshot-4.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="179" src="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLnbAX7lGeI/AAAAAAAAASg/2E1eF3fsigw/s320/Screenshot-4.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 3. 'Config'uring Bash</td></tr></tbody></table><b>Linguistic Perl</b>&nbsp;</div><div>&nbsp;&nbsp; &nbsp;The configuration settings for Perl, created by Larry Wall,&nbsp;was the most "linguistic" out of these! &nbsp;Some excerpts are:<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/_rkBB8V8TgZY/TLpNhHRqUVI/AAAAAAAAASw/8a9uFFopJXE/s1600/perl1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="40" src="http://3.bp.blogspot.com/_rkBB8V8TgZY/TLpNhHRqUVI/AAAAAAAAASw/8a9uFFopJXE/s320/perl1.png" width="320" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/_rkBB8V8TgZY/TLpNiRSBdyI/AAAAAAAAAS0/fT7rHS29KNM/s1600/perl3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="34" src="http://3.bp.blogspot.com/_rkBB8V8TgZY/TLpNiRSBdyI/AAAAAAAAAS0/fT7rHS29KNM/s320/perl3.png" width="320" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/_rkBB8V8TgZY/TLpNkKvfvKI/AAAAAAAAAS4/Uvux1dY0TtA/s1600/perl2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="38" src="http://1.bp.blogspot.com/_rkBB8V8TgZY/TLpNkKvfvKI/AAAAAAAAAS4/Uvux1dY0TtA/s320/perl2.png" width="320" /></a></div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLpNlFuONaI/AAAAAAAAAS8/tNwPzDwjC5s/s1600/perl4.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="19" src="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLpNlFuONaI/AAAAAAAAAS8/tNwPzDwjC5s/s320/perl4.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 4. Excerpts from the 'configure' settings for Perl5</td></tr></tbody></table><b></b><br /><b><div style="display: inline !important; font-weight: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="display: inline !important;"><b>Man pages</b><br /><b></b><br /><b><div style="display: inline !important; font-weight: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="display: inline !important;"><b></b><br /><b><div style="display: inline !important; font-weight: normal; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="display: inline !important;"><div style="display: inline !important;"><b>&nbsp;&nbsp; &nbsp;</b>These had a&nbsp;<b>'</b>make install' with one of the shortest SBU, and looked a bit of a variety too!</div></div></div></b></div></div></b></div></div></b><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLnbJ4gRpQI/AAAAAAAAASs/zV-5WWd0CxE/s1600/Screenshot-2.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="81" src="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLnbJ4gRpQI/AAAAAAAAASs/zV-5WWd0CxE/s320/Screenshot-2.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 5. 'make install' of man pages</td></tr></tbody></table><b>Bash without name !</b><br />&nbsp;&nbsp; &nbsp;During the process, there is a time when 'chroot' is used to completely move into the LFS installation and start using the programs already setup inside it. &nbsp;At this point, the Bash will be setup without creating the <b>/etc/passwd</b> file. Now the Bash will say that <i><b>it has no name !</b></i><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLnbFc85wQI/AAAAAAAAASk/s-h40s5wqNk/s1600/Screenshot.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="115" src="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLnbFc85wQI/AAAAAAAAASk/s-h40s5wqNk/s320/Screenshot.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 6. Bash without /etc/passwd</td></tr></tbody></table>After the Bash has been recompiled and installed properly with respect to the LFS system, and the /etc/passwd file created, the Bash prompt reverts back to normal.</div><div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/_rkBB8V8TgZY/TLnbHhBLSQI/AAAAAAAAASo/pJUGqQ5Mm4o/s1600/Screenshot-1.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="50" src="http://2.bp.blogspot.com/_rkBB8V8TgZY/TLnbHhBLSQI/AAAAAAAAASo/pJUGqQ5Mm4o/s320/Screenshot-1.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 7. Bash after recompiling and creating /etc/passwd</td></tr></tbody></table><b>Booting in ...</b></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLppN43P6YI/AAAAAAAAATQ/XsL1RWCwNOI/s1600/boot2.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="162" src="http://4.bp.blogspot.com/_rkBB8V8TgZY/TLppN43P6YI/AAAAAAAAATQ/XsL1RWCwNOI/s320/boot2.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 8. Booting into the UML kernel</td></tr></tbody></table><div><b>Powering off ...</b></div><div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/_rkBB8V8TgZY/TLplqQmjYOI/AAAAAAAAATI/Ig_fzO0AuQM/s1600/boot3.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="162" src="http://1.bp.blogspot.com/_rkBB8V8TgZY/TLplqQmjYOI/AAAAAAAAATI/Ig_fzO0AuQM/s320/boot3.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fig 9. Powering off the UML kernel</td></tr></tbody></table></div></div></div>